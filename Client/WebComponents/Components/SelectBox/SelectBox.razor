@using Microsoft.JSInterop
@typeparam TItem

<div class="select-box-container" id="@_selectBoxId" @onclick="ToggleDropdown">
    <div class="select-box-display">
        @if (_selectedItem != null)
        {
            @if (ItemTemplate != null)
            {
                @ItemTemplate(_selectedItem)
            }
            else
            {
                @_selectedItem.ToString()
            }
        }
        else
        {
            <span class="placeholder">@Placeholder</span>
        }
    </div>
</div>

@if (_isOpen)
{
    <div class="dropdown-container" id="@_dropdownId">
        @if (Autocomplete)
        {
            <input type="text" class="dropdown-filter"
                   @bind="_filterText"
                   placeholder="Enter text to filter"
                   @oninput="OnFilterChanged" />
        }
        <div class="dropdown-items" id="@_dropdownItemsId">
            @foreach (var item in _displayedItems)
            {
                <div class="dropdown-item" @onclick="(() => SelectItem(item))">
                    @if (ItemTemplate != null)
                    {
                        @ItemTemplate(item)
                    }
                    else
                    {
                        @item!.ToString()
                    }
                </div>
            }
            @if (_isLoading)
            {
                <div class="loading">Loading...</div>
            }
        </div>
    </div>
}

@code {
    #region Component Parameters

    /// <summary>
    /// Local list of items (used for standard select and local filtering)
    /// </summary>
    [Parameter]
    public IEnumerable<TItem>? Items { get; set; }

    /// <summary>
    /// Enables autocomplete mode (displays an input field for filtering)
    /// </summary>
    [Parameter]
    public bool Autocomplete { get; set; }

    /// <summary>
    /// Delegate for implementing local collection search.
    /// The current filter value is passed when invoked.
    /// </summary>
    [Parameter]
    public Func<string?, Task<IEnumerable<TItem>>>? OnSearch { get; set; }

    /// <summary>
    /// Delegate for server-side data loading.
    /// A request object with pagination and filter parameters is passed when invoked.
    /// </summary>
    [Parameter]
    public Func<ServerSideRequest, Task<ServerSideResponse<TItem>>>? OnServerSideSearch { get; set; }

    /// <summary>
    /// Template for displaying an item.
    /// </summary>
    [Parameter]
    public RenderFragment<TItem>? ItemTemplate { get; set; }

    /// <summary>
    /// Callback invoked when an item is selected.
    /// </summary>
    [Parameter]
    public EventCallback<TItem> OnItemSelected { get; set; }

    /// <summary>
    /// Placeholder text displayed when no item is selected.
    /// </summary>
    [Parameter]
    public string Placeholder { get; set; } = "Select...";

    /// <summary>
    /// Page size for server-side loading (number of items per request).
    /// </summary>
    [Parameter]
    public int ServerSidePageSize { get; set; } = 10;

    #endregion

    #region Local Variables

    private bool _isOpen;
    private string? _filterText;
    private List<TItem> _displayedItems = new();
    private TItem? _selectedItem;
    private bool _isLoading;
    private int _serverSideCurrentIndex;
    private int _totalCount;
    private bool _hasMoreData = true;

    // Unique identifiers for binding DOM elements (used in JS methods)
    private readonly string _selectBoxId = $"selectbox_{Guid.NewGuid()}";
    private readonly string _dropdownId = $"dropdown_{Guid.NewGuid()}";
    private readonly string _dropdownItemsId = $"dropdownItems_{Guid.NewGuid()}";
    private DotNetObjectReference<SelectBox<TItem>> _dotNetObjectReference = null!;

    [Inject]
    private IJSRuntime JsRuntime { get; set; } = null!;

    #endregion

    #region Lifecycle and Rendering Methods

    private bool _initializedDropdown;

    /// <summary>
    /// After rendering, if the dropdown is open, call JS to position the dropdown list.
    /// </summary>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetObjectReference = DotNetObjectReference.Create(this);
        }

        if (_isOpen)
        {
            if (!_initializedDropdown)
            {
                _initializedDropdown = true;
                await JsRuntime.InvokeVoidAsync("_selectLib.addScrollDropdownEventListeners", _dropdownItemsId, _dotNetObjectReference);
            }

            await JsRuntime.InvokeVoidAsync("_selectLib.positionDropdown", _selectBoxId, _dropdownId, _dropdownItemsId);
        }

        if (!_isOpen)
        {
            _initializedDropdown = false;
        }
    }

    /// <summary>
    /// Toggles the dropdown state.
    /// When opened, resets the filter and starts data loading.
    /// </summary>
    private async Task ToggleDropdown()
    {
        _isOpen = !_isOpen;
        if (_isOpen)
        {
            _filterText = null;
            _serverSideCurrentIndex = 0;
            _hasMoreData = true;
            await LoadData();
        }
        else
        {
            await JsRuntime.InvokeVoidAsync("_selectLib.resetScrollDropdownEventListeners", _dropdownItemsId);
        }
    }

    [JSInvokable]
    public async Task LoadData(bool append = false)
    {
        if (!_hasMoreData)
        {
            return;
        }

        if (OnServerSideSearch != null)
        {
            _isLoading = true;
            StateHasChanged();
            var request = new ServerSideRequest
            {
                StartIndex = _serverSideCurrentIndex,
                Count = ServerSidePageSize,
                Filter = _filterText
            };
            var result = await OnServerSideSearch(request);
            if (append)
            {
                _displayedItems.AddRange(result.Items);
            }
            else
            {
                _displayedItems = result.Items.ToList();
            }
            _serverSideCurrentIndex += ServerSidePageSize;
            _totalCount = result.TotalCount;

            if (_displayedItems.Count >= _totalCount)
            {
                await JsRuntime.InvokeVoidAsync("_selectLib.resetScrollDropdownEventListeners", _dropdownItemsId);
                _hasMoreData = false;
            }

            _isLoading = false;
            StateHasChanged();
        }
        else if (Autocomplete && OnSearch != null)
        {
            _isLoading = true;
            StateHasChanged();
            var result = await OnSearch(_filterText);
            _displayedItems = result.ToList();
            _isLoading = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Filter change handler.
    /// Reloads data when the filter changes.
    /// </summary>
    private async Task OnFilterChanged(ChangeEventArgs e)
    {
        _filterText = e.Value?.ToString() ?? "";
        _serverSideCurrentIndex = 0;

        if (!_hasMoreData)
        {
            await JsRuntime.InvokeVoidAsync("_selectLib.addScrollDropdownEventListeners", _dropdownItemsId, _dotNetObjectReference);
            _hasMoreData = true;
        }
        await LoadData();
    }

    /// <summary>
    /// Selects an item from the dropdown.
    /// Closes the dropdown and invokes the selection callback.
    /// </summary>
    private async Task SelectItem(TItem item)
    {
        _selectedItem = item;
        _isOpen = false;
        await OnItemSelected.InvokeAsync(item);
    }

    #endregion
}